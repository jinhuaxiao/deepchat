<template>
  <div
    class="w-full max-w-5xl mx-auto"
    @dragenter.prevent="handleDragEnter"
    @dragover.prevent="handleDragOver"
    @drop.prevent="handleDrop"
    @dragleave.prevent="handleDragLeave"
    @paste="handlePaste"
  >
    <TooltipProvider>
      <div
        class="bg-background-super-200 border border-border/40 rounded-3xl focus-within:ring-2 focus-within:ring-primary/20 focus-within:border-primary/70 p-4 flex flex-col gap-3 shadow-md hover:shadow-lg transition-all duration-200 relative"
      >
        <!-- 文件区域 -->
        <div v-if="selectedFiles.length > 0" class="pb-1">
          <TransitionGroup
            name="file-list"
            tag="div"
            class="flex flex-wrap gap-2"
            enter-active-class="transition-all duration-300 ease-in-out"
            leave-active-class="transition-all duration-300 ease-in-out"
            enter-from-class="opacity-0 scale-95"
            leave-to-class="opacity-0 scale-95"
            move-class="transition-transform duration-300 ease-in-out"
          >
            <FileItem
              v-for="(file, idx) in selectedFiles"
              :key="file.metadata.fileName"
              :file-name="file.metadata.fileName"
              :deletable="true"
              :mime-type="file.mimeType"
              :tokens="file.token"
              @click="previewFile(file.path)"
              @delete="deleteFile(idx)"
            />
          </TransitionGroup>
        </div>
        
        <!-- 输入区域 -->
        <Textarea
          ref="textareaRef"
          v-model="inputText"
          :auto-focus="true"
          :rows="rows"
          :max-rows="maxRows"
          :placeholder="t('chat.input.placeholder')"
          class="textarea-selector border-none max-h-[10rem] shadow-none p-2 focus-visible:ring-0 focus-within:ring-0 ring-0 outline-none focus-within:outline-none text-sm resize-none overflow-y-auto transition-all duration-200 bg-transparent"
          @keydown.enter.exact.prevent="handleEnterKey"
          @input="adjustHeight"
        ></Textarea>

        <div class="flex items-center justify-between">
          <!-- 功能按钮区 -->
          <div class="flex gap-2 flex-wrap items-center">
            <Tooltip>
              <TooltipTrigger>
                <Button
                  variant="outline"
                  size="icon"
                  class="w-8 h-8 rounded-full text-muted-foreground hover:text-primary hover:bg-primary/10 hover:scale-105 transition-all duration-200 shadow-sm border-border/40"
                  @click="openFilePicker"
                >
                  <Icon icon="lucide:paperclip" class="w-4 h-4" />
                  <input
                    ref="fileInput"
                    type="file"
                    class="hidden"
                    multiple
                    accept="application/json,application/javascript,text/plain,text/csv,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.oasis.opendocument.spreadsheet,application/vnd.ms-excel.sheet.binary.macroEnabled.12,application/vnd.apple.numbers,text/markdown,application/x-yaml,application/xml,application/typescript,text/typescript,text/x-typescript,application/x-typescript,application/x-sh,text/*,application/pdf,image/jpeg,image/jpg,image/png,image/gif,image/webp,image/bmp,image/*,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-powerpoint,application/vnd.openxmlformats-officedocument.presentationml.presentation,text/html,text/css,application/xhtml+xml,.js,.jsx,.ts,.tsx,.py,.java,.c,.cpp,.cs,.go,.rb,.php,.rs,.swift,.kt,.scala,.pl,.lua,.sh,.json,.yaml,.yml,.xml,.html,.htm,.css,.md"
                    @change="handleFileSelect"
                  />
                </Button>
              </TooltipTrigger>
              <TooltipContent>{{ t('chat.input.fileSelect') }}</TooltipContent>
            </Tooltip>

            <!-- 网络搜索选择器 -->
            <Tooltip>
              <TooltipTrigger>
                <span
                  class="search-engine-select overflow-hidden flex items-center h-8 rounded-full shadow-md border border-border/40 transition-all duration-300 hover:border-primary/70 hover:shadow-lg"
                  :class="{
                    'border-primary/70 ring-1 ring-primary/20 bg-primary/5': settings.webSearch
                  }"
                  @mouseenter="isSearchHovering = true"
                  @mouseleave="isSearchHovering = false"
                >
                  <Button
                    variant="outline"
                    :class="[
                      'flex w-8 border-none rounded-l-full items-center justify-center h-full transition-all duration-200 hover:scale-105',
                      settings.webSearch
                        ? 'bg-primary text-primary-foreground hover:bg-primary/90 shadow-sm ring-1 ring-primary/20'
                        : 'text-foreground dark:text-muted-foreground hover:text-primary hover:bg-primary/10 border border-border/40 dark:border-border/20 dark:hover:bg-accent/20'
                    ]"
                    size="icon"
                    @click="onWebSearchClick"
                  >
                    <Icon icon="lucide:globe" class="w-4 h-4" />
                  </Button>
                  <Select
                    v-model="selectedSearchEngine"
                    @update:model-value="onSearchEngineChange"
                    @update:open="handleSelectOpen"
                  >
                    <SelectTrigger
                      class="h-full rounded-none border-none shadow-none hover:bg-accent text-muted-foreground dark:hover:text-primary-foreground transition-all duration-300 rounded-r-full"
                      :class="{
                        'w-0 opacity-0 p-0 overflow-hidden':
                          !showSearchSettingsButton && !isSearchHovering && !isSelectOpen,
                        'w-24 max-w-28 px-2 opacity-100':
                          showSearchSettingsButton || isSearchHovering || isSelectOpen
                      }"
                    >
                      <div class="flex items-center gap-1">
                        <SelectValue class="text-xs font-bold truncate" />
                      </div>
                    </SelectTrigger>
                    <SelectContent align="start" class="w-64">
                      <SelectItem
                        v-for="engine in searchEngines"
                        :key="engine.id"
                        :value="engine.id"
                        class="transition-colors duration-200"
                      >
                        {{ engine.name }}
                      </SelectItem>
                    </SelectContent>
                  </Select>
                </span>
              </TooltipTrigger>
              <TooltipContent>{{ t('chat.features.webSearch') }}</TooltipContent>
            </Tooltip>

            <McpToolsList />
            <slot name="addon-buttons"></slot>
          </div>
          
          <!-- 发送按钮和上下文长度 -->
          <div class="flex items-center gap-3">
            <div
              v-if="
                contextLength &&
                contextLength > 0 &&
                currentContextLength / (contextLength ?? 1000) > 0.5
              "
              class="text-xs font-medium rounded-full px-2 py-0.5 bg-background/50 backdrop-blur-sm"
              :class="[
                currentContextLength / (contextLength ?? 1000) > 0.9 ? 'text-red-500 bg-red-500/10' : '',
                currentContextLength / (contextLength ?? 1000) > 0.8
                  ? 'text-yellow-500 bg-yellow-500/10'
                  : 'text-muted-foreground'
              ]"
            >
              {{ currentContextLengthText }}
            </div>
            <Button
              variant="default"
              size="icon"
              class="w-10 h-10 rounded-full shadow-lg hover:shadow-xl hover:scale-105 transition-all duration-200"
              :class="{ 'bg-primary hover:bg-primary/90 ring-1 ring-primary/20': !disabledSend }"
              :disabled="disabledSend"
              @click="emitSend"
            >
              <Icon icon="lucide:arrow-up" class="w-5 h-5" />
            </Button>
          </div>
        </div>
        
        <!-- 拖拽文件覆盖层 -->
        <div 
          v-if="isDragging" 
          class="absolute inset-0 bg-primary/10 backdrop-blur-sm rounded-3xl border-2 border-dashed border-primary/70 transition-all duration-200 animate-pulse-subtle"
        >
          <div class="flex items-center justify-center h-full gap-2">
            <Icon icon="lucide:file-up" class="w-5 h-5 text-primary" />
            <span class="text-sm font-medium text-primary">Drop files here</span>
          </div>
        </div>
      </div>
    </TooltipProvider>
  </div>
</template>

<script setup lang="ts">
import { useI18n } from 'vue-i18n'
import { computed, onMounted, ref, watch } from 'vue'
import { Textarea } from '@/components/ui/textarea'
import { Button } from '@/components/ui/button'
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue
} from '@/components/ui/select'
import { Icon } from '@iconify/vue'
import FileItem from './FileItem.vue'
import { useChatStore } from '@/stores/chat'
import { MessageFile, UserMessageContent } from '@shared/chat'
import { usePresenter } from '@/composables/usePresenter'
import { approximateTokenSize } from 'tokenx'
import { useSettingsStore } from '@/stores/settings'
import McpToolsList from './mcpToolsList.vue'
import { useEventListener } from '@vueuse/core'
import { calculateImageTokens, getClipboardImageInfo, imageFileToBase64 } from '@/lib/image'

const { t } = useI18n()
const configPresenter = usePresenter('configPresenter')
const chatStore = useChatStore()
const settingsStore = useSettingsStore()
const inputText = ref('')
const fileInput = ref<HTMLInputElement>()
const filePresenter = usePresenter('filePresenter')
const windowPresenter = usePresenter('windowPresenter')
const settings = ref({
  deepThinking: false,
  webSearch: false
})
const selectedSearchEngine = ref('')
const searchEngines = computed(() => settingsStore.searchEngines)
const currentContextLength = computed(() => {
  return (
    approximateTokenSize(inputText.value) +
    selectedFiles.value.reduce((acc, file) => {
      return acc + file.token
    }, 0)
  )
})

const textareaRef = ref<HTMLTextAreaElement>()
const isDragging = ref(false)
const dragCounter = ref(0)
let dragLeaveTimer: number | null = null

const selectedFiles = ref<MessageFile[]>([])
const props = withDefaults(
  defineProps<{
    contextLength?: number
    maxRows?: number
    rows?: number
  }>(),
  {
    maxRows: 10,
    rows: 1
  }
)

const currentContextLengthText = computed(() => {
  return `${Math.round((currentContextLength.value / (props.contextLength ?? 1000)) * 100)}%`
})

const emit = defineEmits(['send', 'file-upload'])

const openFilePicker = () => {
  fileInput.value?.click()
}

const previewFile = (filePath: string) => {
  windowPresenter.previewFile(filePath)
}

const handlePaste = async (e: ClipboardEvent) => {
  const files = e.clipboardData?.files
  if (files && files.length > 0) {
    for (const file of files) {
      if (file.type.startsWith('image/')) {
        const base64 = (await imageFileToBase64(file)) as string
        const imageInfo = await getClipboardImageInfo(file)

        const fileInfo: MessageFile = {
          name: file.name ?? 'image',
          content: base64,
          mimeType: file.type,
          metadata: {
            fileName: file.name ?? 'image',
            fileSize: file.size,
            // fileHash: string
            fileDescription: file.type,
            fileCreated: new Date(),
            fileModified: new Date()
          },
          token: calculateImageTokens(imageInfo.width, imageInfo.height),
          path: ''
        }
        if (fileInfo) {
          selectedFiles.value.push(fileInfo)
        }
      }
    }
    if (selectedFiles.value.length > 0) {
      emit('file-upload', selectedFiles.value)
    }
  }
}

const handleFileSelect = async (e: Event) => {
  const files = (e.target as HTMLInputElement).files

  if (files && files.length > 0) {
    for (const file of files) {
      const path = window.api.getPathForFile(file)
      try {
        const fileInfo: MessageFile = await filePresenter.prepareFile(path, file.type)
        if (fileInfo) {
          selectedFiles.value.push(fileInfo)
        } else {
          console.error('File info is null:', file.name)
        }
      } catch (error) {
        console.error('文件准备失败:', error)
        // Don't return here, continue processing other files
      }
    }
    if (selectedFiles.value.length > 0) {
      emit('file-upload', selectedFiles.value)
    }
  }
  // Reset the input
  if (e.target) {
    ;(e.target as HTMLInputElement).value = ''
  }
}

const emitSend = () => {
  if (inputText.value.trim()) {
    const messageContent: UserMessageContent = {
      text: inputText.value.trim(),
      files: selectedFiles.value,
      links: [],
      search: settings.value.webSearch,
      think: settings.value.deepThinking
    }

    emit('send', messageContent)
    inputText.value = ''

    // 清理已上传的文件
    if (selectedFiles.value.length > 0) {
      // 清空文件列表
      selectedFiles.value = []
      // 重置文件输入控件
      if (fileInput.value) {
        fileInput.value.value = ''
      }
    }
  }
}

const adjustHeight = (e: Event) => {
  const target = e.target as HTMLTextAreaElement
  target.style.height = 'auto'
  target.style.height = `${target.scrollHeight}px`
}

const deleteFile = (idx: number) => {
  selectedFiles.value.splice(idx, 1)
  if (fileInput.value) {
    fileInput.value.value = ''
  }
}

const disabledSend = computed(() => {
  return (
    chatStore.generatingThreadIds.has(chatStore.activeThreadId ?? '') ||
    inputText.value.length <= 0 ||
    currentContextLength.value > (props.contextLength ?? chatStore.chatConfig.contextLength)
  )
})

const handleEnterKey = (e: KeyboardEvent) => {
  if (disabledSend.value) {
    return
  }
  if (!e.isComposing) {
    emitSend()
  }
}

const onWebSearchClick = async () => {
  settings.value.webSearch = !settings.value.webSearch
  await configPresenter.setSetting('input_webSearch', settings.value.webSearch)
}

const onSearchEngineChange = async (engineName: string) => {
  await settingsStore.setSearchEngine(engineName)
}

const initSettings = async () => {
  settings.value.deepThinking = Boolean(await configPresenter.getSetting('input_deepThinking'))
  settings.value.webSearch = Boolean(await configPresenter.getSetting('input_webSearch'))
  selectedSearchEngine.value = settingsStore.activeSearchEngine?.id ?? 'google'
}

const handleDragEnter = (e: DragEvent) => {
  dragCounter.value++
  isDragging.value = true

  // 确保目标是文件
  if (e.dataTransfer?.types.includes('Files')) {
    isDragging.value = true
  }
}

const handleDragOver = () => {
  // 防止默认行为并保持拖拽状态
  if (dragLeaveTimer) {
    clearTimeout(dragLeaveTimer)
    dragLeaveTimer = null
  }
}

const handleDragLeave = () => {
  dragCounter.value--

  // 只有当计数器归零时才隐藏拖拽状态，并添加小延迟防止闪烁
  if (dragCounter.value <= 0) {
    if (dragLeaveTimer) clearTimeout(dragLeaveTimer)

    dragLeaveTimer = window.setTimeout(() => {
      if (dragCounter.value <= 0) {
        isDragging.value = false
        dragCounter.value = 0
      }
      dragLeaveTimer = null
    }, 50)
  }
}

const handleDrop = async (e: DragEvent) => {
  isDragging.value = false
  dragCounter.value = 0

  if (e.dataTransfer?.files && e.dataTransfer.files.length > 0) {
    for (const file of e.dataTransfer.files) {
      try {
        const path = window.api.getPathForFile(file)
        const fileInfo: MessageFile = await filePresenter.prepareFile(path)
        console.log('fileInfo', fileInfo)
        if (fileInfo) {
          selectedFiles.value.push(fileInfo)
        }
      } catch (error) {
        console.error('文件准备失败:', error)
        return
      }
    }
    emit('file-upload', selectedFiles.value)
  }
}

// Search engine selector variables
const showSearchSettingsButton = ref(false)
const isSearchHovering = ref(false)
const isSelectOpen = ref(false)

// Handle select open state
const handleSelectOpen = (isOpen: boolean) => {
  isSelectOpen.value = isOpen
}

// 添加鼠标悬停事件处理函数
const handleSearchMouseEnter = (): void => {
  isSearchHovering.value = true
}

const handleSearchMouseLeave = (): void => {
  isSearchHovering.value = false
}

onMounted(() => {
  initSettings()

  // Add event listeners for search engine selector hover with auto remove
  const searchElement = document.querySelector('.search-engine-select')
  if (searchElement) {
    useEventListener(searchElement, 'mouseenter', handleSearchMouseEnter)
    useEventListener(searchElement, 'mouseleave', handleSearchMouseLeave)
  }
})

watch(
  () => settingsStore.activeSearchEngine?.id,
  async () => {
    selectedSearchEngine.value = settingsStore.activeSearchEngine?.id ?? 'google'
  }
)
defineExpose({
  setText: (text: string) => {
    inputText.value = text
  }
})
</script>

<style scoped>
.animate-pulse-subtle {
  animation: pulse-subtle 2s infinite;
}

@keyframes pulse-subtle {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.8;
  }
}
</style>
